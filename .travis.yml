language: c
sudo: false

addons:
  apt:
    packages:
    - libssl-dev
    - libevent-dev
    - libexpat-dev
    - clang

jobs:
  include:
    - os: osx
      name: Clang on OS X, Amd64
      compiler: clang
      arch: amd64

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" = "osx" ]; then
        brew update
        brew install openssl
        which openssl
    fi
script:
  - |
    if [ "$TEST_UBSAN" = "yes"  ]; then
      export CFLAGS="-DNDEBUG -g2 -O3 -fsanitize=undefined -fno-sanitize-recover"
      ./configure
    elif [ "$TEST_ASAN" = "yes" ]; then
      export CFLAGS="-DNDEBUG -g2 -O3 -fsanitize=address"
      ./configure
    elif [ "$TRAVIS_OS_NAME" = "osx" ]; then
      export LDFLAGS="-L/usr/local/opt/openssl/lib"
      export CFLAGS="-I/usr/local/opt/openssl/include"
      ./configure --enable-debug --disable-flto
    else
      ./configure --enable-debug --disable-flto
    fi
  - make -j 2
  - make test
  - (cd testdata/clang-analysis.tdir; bash clang-analysis.test)
